{"version":3,"sources":["models/index.js"],"names":[],"mappings":"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","file":"models/index.js","sourcesContent":["import moment from 'moment';\nimport _ from 'lodash';\nimport async from 'lodash';\nimport uuid from 'uuid';\nimport {dmy} from '../helpers';\n\nclass Node {\n  constructor({label, transacId, parentId, type} = {}){\n    this.id = uuid();\n    this.createdAt = new Date();\n    this.transacId = transacId;\n    if(parentId)this.parentId = parentId;\n    this.type = type;\n    this.label = label;\n  }\n\n  isTransac(){\n    return this.type === 'transac';\n  }\n\n  isEvent(){\n    return this.type === 'event';\n  }\n\n  isMessage(){\n    return this.type === 'message';\n  }\n\n\n  get children(){\n    return this._children || [];\n  }\n\n  addChild(node){\n    if(!this._children) this._children = [];\n    this._children.push(node);\n    node.parentId = this.id;\n    return this;\n  }\n\n  isLeaf(){\n    return !this.length;\n  }\n\n  [Symbol.iterator](){\n    let done = {}, node, remainingNodes = [this];\n    function iterate(nodes){\n      let child = nodes[0];\n      if(!child) return [null, []];\n      if(child.isLeaf() || done[child.id]) return [child, nodes.slice(1)];\n      nodes.splice(0, 0, ...child.children);\n      done[child.id] = true;\n      return iterate(nodes);\n    }\n\n    return {\n      [Symbol.iterator](){\n        return this;\n      },\n      next(){\n        [node, remainingNodes] =  iterate(remainingNodes);\n        if(node)return {value: node};\n        else return {done: true};\n      }\n    }\n  }\n\n  get status(){\n    if(this.hasStatuses(['error', 'abort'])) return 'error';\n    if(this.hasStatuses(['warning'])) return 'warning';\n    return 'ok';\n  }\n\n  hasStatuses(statuses){\n    return _.some(this.children, function(child){return _.contains(statuses, child.status)});\n  }\n\n  hasLevel(level){\n    return _.some(this.children, function(child){return child.level === level});\n  }\n\n  get length(){\n    return this.children.length;\n  }\n\n  get lastChild(){\n    return this.children && this.children[this.length - 1];\n  }\n\n  get lastMessage(){\n    let nodes = _.filter([...this], node => node.isMessage());\n    return nodes[nodes.length-1];\n  }\n\n  get lastMessageTime(){\n    let lastMessage = this.lastMessage;\n    return lastMessage && lastMessage.createdAt;\n  }\n\n\n}\n\nexport function bless(obj){\n  if(!obj)return;\n  switch(obj.type){\n    case 'transac':\n      obj.__proto__ = Transac.prototype;\n      break\n    case 'event':\n      obj.__proto__ = Event.prototype;\n      break\n    case 'message':\n      obj.__proto__ = Message.prototype;\n      break\n  }\n  return obj;\n}\n\n\nexport class Transac extends Node {\n\n  constructor({label, valueDate=moment().startOf('day').toDate(), parentId, server, user, processId, locked=false, compound=false, transacId} = {}){\n    super({label: label, parentId: parentId, transacId: transacId, type: 'transac'});\n    if(!this.transacId) this.transacId = this.id;\n    this.valueDate = valueDate;\n    if(server) this.server = server;\n    if(user) this.user = user;\n    if(processId) this.processId = processId;\n    if(locked) this.locked = locked;\n    if(compound){ this.compound = true };\n  }\n\n  static get collection(){ \n    return \"transacs\";\n  }\n\n  static makeCompoundRoot(transac){\n    let root = new Transac({label: transac.label, valueDate:transac.valueDate, compound: true, transacId: transac.transacId});\n    root._children = [];\n    root.root = true;\n    return root;\n  }\n\n  // to keep compatible with older version\n  addEvent(event){\n    let transac = this;\n    if(transac.lastChild && transac.lastChild.isTransac()) return transac.lastChild.addEvent(event);\n    transac.addChild(event);\n    return this;\n  }\n\n  isCompound(){\n    return this.compound;\n  }\n\n  isLocked(){\n    return this.locked;\n  }\n\n  isRunning(){\n    //return !this.hasStatuses(['abort', 'commit']);\n    let lastMessage = this.lastMessage;\n    return !lastMessage || !_.contains(['abort', 'commit'], lastMessage.level);\n  }\n\n  get delay(){\n    let lastMessage = this.lastMessage;\n    if(lastMessage) return lastMessage.createdAt - this.createdAt;\n    else return 0;\n  }\n\n  toSummaryJSON(){\n    return {\n      id: this.id,\n      transacId: this.transacId,\n      label: this.label,\n      valueDate: dmy(this.valueDate),\n      createdAt: +this.createdAt,\n      lastMessageTime: this.lastMessageTime && +this.lastMessageTime,\n      locked: this.isLocked(),\n      status: this.status,\n      isRunning: this.isRunning(),\n      isCompound: this.isCompound(),\n      server: this.server,\n      delay: this.delay\n    }\n  }\n\n  toJSON(){\n    return {\n      id: this.id,\n      type: this.type,\n      transacId: this.transacId,\n      label: this.label,\n      valueDate: dmy(this.valueDate),\n      createdAt: +this.createdAt,\n      lastMessageTime: this.lastMessageTime && +this.lastMessageTime,\n      locked: this.isLocked(),\n      status: this.status,\n      isRunning: this.isRunning(),\n      isCompound: this.isCompound(),\n      server: this.server,\n      processId: this.processId,\n      user: this.user,\n      delay: this.delay,\n      children: _.map(this.children, child => child.toJSON()),\n    }\n  }\n\n\n}\n\n\nexport class Event extends Node{\n  constructor({transacId, parentId, label} = {}){\n    super({label: label, transacId: transacId, parentId: parentId, type: 'event'});\n  }\n\n  toJSON(){\n    return {\n      id: this.id,\n      type: this.type,\n      transacId: this.transacId,\n      status: this.status,\n      label: this.label,\n      children: _.map(this.children, child => child.toJSON()),\n      createdAt: +this.createdAt\n    }\n  }\n}\n\nexport class Message extends Node{\n  constructor({transacId, parentId, level='ok', label} = {}){\n    super({label: label, transacId: transacId, parentId: parentId, type: 'message'});\n    this.level = level;\n  }\n\n  get status(){\n    if(this.level === 'abort' || this.level === 'error') return 'error';\n    if(this.level === 'warning') return 'warning';\n    return 'ok';\n  }\n\n  toJSON(){\n    return {\n      id: this.id,\n      type: this.type,\n      transacId: this.transacId,\n      label: this.label,\n      level: this.level,\n      status: this.status,\n      createdAt: +this.createdAt\n    }\n  }\n}\n\n"],"sourceRoot":"/home/redpelicans/transacd2/server/src"}