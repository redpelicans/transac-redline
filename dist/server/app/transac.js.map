{"version":3,"sources":["app/transac.js"],"names":[],"mappings":"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","file":"app/transac.js","sourcesContent":["import {Transac} from '../models';\nimport {TransacError} from '../helpers';\nimport {dmy, FMT} from '../helpers';\nimport * as transacs from '../helpers/transac';\nimport express from 'express';\nimport async from 'async';\nimport moment from 'moment';\nimport _ from 'lodash';\n\nexport function init(params, $, cb){\n  let app = express();\n\n  app.get('/transacs', loadTransacs);\n  app.get('/transacs/:id', loadTransac);\n  app.post('/transacs', createTransac);\n  app.put('/transacs/:id/events', createEvent);\n\n  function loadTransacs(req, res, next){\n    let options = {\n        label: req.query.label\n      , from: req.query.from && moment(req.query.from, FMT).startOf('day').toDate()\n      , to: req.query.to && moment(req.query.to, FMT).startOf('day').toDate()\n      , dateMode: req.query.mode == 'v' ? 'valueDate' : 'createdAt'\n    }\n\n    transacs.loadAll($.conn, options, (err, transacs) => {\n      if(err) return next(err);\n      res.json(_.map(transacs, transac=>transac.toSummaryJSON()));\n    });\n\n  }\n\n  function loadTransac(req, res, next){\n    var transacId = req.params.id;\n    transacs.load($.conn, transacId, function(err, transac){\n      if(err) return next(err);\n      if(!transac) return new Error(\"Unknown transac\");\n      res.json(transac.toJSON());\n    })\n  }\n\n\n  function createTransac(req, res, next){\n    let options = req.body;\n    if('valueDate' in options) options.valueDate = moment(options.valueDate, FMT).toDate();\n    if('locked' in options) options.locked = options.locked === 'true';\n    if('compound' in options) options.compound = options.compound === 'true';\n    if('processId' in options) options.processId = +options.processId;\n\n    \n    transacs.loadOrCreate($.conn, options, (err, transac) => {\n      if(err) return next(err);\n      res.json(transac.toSummaryJSON());\n    });\n  }\n\n  function createEvent(req, res, next){\n    var transacId = req.params.id\n      , options = _.pick(req.body, 'level', 'label', 'messages');\n\n    transacs.addEvent($.conn, transacId, options, function(err, transac){\n      if(err){\n        if(err instanceof TransacError) res.status(418).json(err);\n        else next(err);\n      }else res.status(200).end();\n    });\n  }\n\n  return app;\n}\n"],"sourceRoot":"/home/redpelicans/transacd2/src/server"}