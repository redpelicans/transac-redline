{"version":3,"sources":["helpers/transac.js"],"names":[],"mappings":"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","file":"helpers/transac.js","sourcesContent":["import r from 'rethinkdb';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport uuid from 'uuid';\nimport async from 'async';\nimport {Transac, Event, Message, bless} from '../models';\nimport {TransacError} from '../helpers';\n\nexport function loadOrCreate(conn, options, cb){\n  findOne(conn, options, (err, transac) => {\n    if(err) return cb(err);\n    if(!transac) return insertOne(conn, options, null, cb);\n    if(transac.isLocked()) return cb(new TransacError('Transaction already locked', 'locked'));\n    if(transac.isCompound() && options.compound)return insertOne(conn, options, transac, cb);\n    insertOne(conn, options, null, cb);\n  });\n}\n\n// export to be tested\nexport function findOne(conn, options, cb){\n  let query = r.table(Transac.collection).filter(r.row.hasFields('parentId').not()).filter({label: options.label, type: 'transac'});\n\n  if(options.valueDate){\n    let from = moment(options.valueDate).startOf('day').toDate()\n      , to = moment(options.valueDate).endOf('day').toDate();\n\n    query = query.filter( t => {\n      return t('valueDate').during(from, to, {leftBound: \"closed\", rightBound: \"closed\"});\n    });\n  }\n\n  if(options.compound) query = query.orderBy(r.asc('createdAt'));\n  else query = query.orderBy(r.desc('createdAt'));\n\n  query.run(conn, (err, cursor) => {\n    if(err) return cb(err);\n    cursor.toArray((err, transacs) => {\n      if(err) return cb(err);\n      let transac = transacs[0];\n      if(!transac)return cb();\n      cb(null, bless(transac));\n    });\n  });\n}\n\nexport function loadAll(conn, {label, from=moment().startOf('day').toDate(), to=moment().endOf('day').toDate(), dateMode='valueDate'} = {}, cb){\n  function findAll(cb){\n    let query =  r.table(Transac.collection).filter( \n      r.row(dateMode === 'valueDate' ? 'valueDate' : 'createdAt').during(from, to, {leftBound: \"closed\", rightBound: \"closed\"}) \n    );\n    if(label) query = query.filter({label: label});\n\n    query.run(conn, (err, cursor) => {\n      if(err) return cb(err);\n      cursor.toArray((err, transacs) => {\n        if(err) return cb(err);\n        let transacIds = _.inject(transacs, (res, transac) => { res[transac.transacId] = transac.transacId; return res}, {});\n        cb(null, _.keys(transacIds));\n      });\n    });\n  }\n  function loadTransacs(transacIds, cb){\n    async.map(transacIds, load.bind(null, conn), cb);\n  }\n\n  async.waterfall([findAll, loadTransacs], cb);\n}  \n\nexport function load(conn, id, cb){\n  r.table(Transac.collection).filter({transacId: id}).orderBy(r.asc('createdAt')).run(conn, (err, cursor) => {\n    if(err)return cb(err);\n    cursor.toArray((err, nodes) => {\n      if(err)return cb(err);\n      let root, hnodes = _.inject(nodes, (res, node) => { res[node.id] = bless(node); return res}, {});\n\n      _.each(nodes, node => {\n        let tnode = hnodes[node.id];\n        if(!tnode.parentId){\n          root = tnode;\n        }else{\n          let parent = hnodes[tnode.parentId];\n          if(!parent){\n            return cb(new Error(\"Wrong Transac Tree\"));\n          }\n          parent.addChild(tnode);\n        }\n      });\n      cb(null, root);\n    })\n  })\n}\n\nfunction insertOne(conn, options, root, cb){\n  if(!options.compound){\n    let transac = new Transac(options);\n    r.table(Transac.collection).insert( transac, {returnChanges: true} ).run(conn, (err, res) => {\n      if(err)return cb(err);\n      cb(null, transac);\n    });\n  }else{\n    let transacs;\n    if(options.compound && !root){\n      root = new Transac(options);\n      transacs = [root, new Transac(_.merge({transacId: root.id, parentId: root.id}, options))];\n    }else{\n      options.transacId = root.transacId;\n      options.parentId = root.id;\n      transacs = [new Transac(options)];\n    }\n    r.table(Transac.collection).insert( transacs, {returnChanges: true} ).run(conn, (err, res) => {\n      if(err)return cb(err);\n      cb(null, root);\n    });\n  }\n}\n\nexport function addEvent(conn, id, options, cb){\n  async.waterfall([\n    load.bind(null, conn, id),\n    (transac, cb) => {\n      if(!transac) return setImmediate(cb, new Error(\"Unknown transaction\"));\n      let targetTransac = transac.isCompound() ? transac.lastChild : transac\n        , recipe = options.label ? [addEventTransac(conn, targetTransac, options), addMessages.bind(null, conn, targetTransac, options)] : [addMessages.bind(null, conn, targetTransac, options, targetTransac)];\n      async.waterfall(recipe, cb);\n    }\n  ], cb); \n}\n\nfunction addEventTransac(conn, transac, options){\n  return function(cb){\n    try{\n      options.transacId = transac.transacId;\n      let event = new Event(options);\n      transac.addEvent(event);\n      r.table(Transac.collection).insert( event, {returnChanges: true} ).run(conn, (err, res) => {\n        if(err)return cb(err);\n        cb(null, event);\n      });\n    }catch(e){\n      setImmediate(cb, e);\n    }\n  }\n}\n\nfunction addMessages(conn, transac, options, parent, cb){\n  try{\n    let messages = _.map(options.messages, message => new Message({label: message, level: options.level, transacId: transac.transacId}));\n    _.each(messages, message => parent.addChild(message));\n    r.table(Transac.collection).insert( messages, {returnChanges: true} ).run(conn, (err, res) => {\n      if(err)return cb(err);\n      cb(null, transac);\n    });\n  }catch(e){\n    setImmediate(cb, e);\n  }\n}\n"],"sourceRoot":"/home/redpelicans/transacd2/src/server"}