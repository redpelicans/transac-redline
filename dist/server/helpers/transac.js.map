{"version":3,"sources":["helpers/transac.js"],"names":[],"mappings":"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","file":"helpers/transac.js","sourcesContent":["import r from 'rethinkdb';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport uuid from 'uuid';\nimport async from 'async';\nimport {Transac, Event, Message, bless} from '../models';\nimport {TransacError} from '../helpers';\n\nexport function loadOrCreate(conn, options, cb){\n  findOne(conn, options, (err, transac) => {\n    if(err) return cb(err);\n    if(!transac) return insertOne(conn, options, cb);\n    if(transac.isLocked()) return cb(new TransacError('Transaction already locked', 'locked'));\n    if(transac.isCompound() && options.compound){ options.transacId = transac.transacId }\n    insertOne(conn, options, cb);\n  });\n}\n\n// export to be tested\nexport function findOne(conn, options, cb){\n  let query = r.table(Transac.collection).filter({label: options.label, type: 'transac'});\n\n  if(options.valueDate){\n    let from = moment(options.valueDate).startOf('day').toDate()\n      , to = moment(options.valueDate).endOf('day').toDate();\n\n    query = query.filter( t => {\n      return t('valueDate').during(from, to, {leftBound: \"closed\", rightBound: \"closed\"});\n    });\n  }\n\n  if(options.compound) query = query.orderBy(r.asc('createdAt'));\n  else query = query.orderBy(r.desc('createdAt'));\n\n  query.run(conn, (err, cursor) => {\n    if(err) return cb(err);\n    cursor.toArray((err, transacs) => {\n      if(err) return cb(err);\n      let transac = transacs[0];\n      if(!transac)return cb();\n      cb(null, bless(transac));\n    });\n  });\n}\n\nexport function loadAll(conn, {label, from=moment().startOf('day').toDate(), to=moment().endOf('day').toDate(), dateMode='valueDate'} = {}, cb){\n  function findAll(cb){\n    let query =  r.table(Transac.collection).filter( \n      r.row(dateMode === 'valueDate' ? 'valueDate' : 'createdAt').during(from, to, {leftBound: \"closed\", rightBound: \"closed\"}) \n    );\n    if(label) query = query.filter({label: label});\n\n    query.run(conn, (err, cursor) => {\n      if(err) return cb(err);\n      cursor.toArray((err, transacs) => {\n        if(err) return cb(err);\n        let transacIds = _.inject(transacs, (res, transac) => { res[transac.transacId] = transac.transacId; return res}, {});\n        cb(null, _.keys(transacIds));\n      });\n    });\n  }\n  function loadTransacs(transacIds, cb){\n    async.map(transacIds, load.bind(null, conn), cb);\n  }\n\n  async.waterfall([findAll, loadTransacs], cb);\n}  \n\nexport function load(conn, id, cb){\n  r.table(Transac.collection).filter({transacId: id}).orderBy(r.asc('createdAt')).run(conn, (err, nodes) => {\n    if(err)return cb(err);\n    let root\n      , hnodes = _.inject(nodes, (res, node) => { res[node.id] = node; return res}, {});\n\n    _.each(nodes, node => {\n      let tnode = bless(node);\n      if(tnode.isTransac() && tnode.isCompound()){\n          if(!root) root = new Transac.makeCompoundRoot(tnode);\n          root.addChild(tnode);\n      }else{\n        if(!tnode.parentId) root = tnode;\n        else{\n          let parent = hnodes[tnode.parentId];\n          if(!parent){\n            console.log(tnode)\n            return cb(new Error(\"Wrong Transac Tree\"));\n          }\n          parent.addChild(tnode);\n        }\n      }\n    });\n    cb(null, root);\n  })\n}\n\nfunction insertOne(conn, options, cb){\n  let transac = new Transac(options);\n  r.table(Transac.collection).insert( transac, {returnChanges: true} ).run(conn, (err, res) => {\n    if(err)return cb(err);\n    cb(null, transac);\n  });\n}\n\nexport function addEvent(conn, id, options, cb){\n  async.waterfall([\n    load.bind(null, conn, id),\n    (transac, cb) => {\n      if(!transac) return setImmediate(cb, new Error(\"Unknown transaction\"));\n      addEventTransac(conn, transac, options, (err, event, transac)=>{\n        if(err)return cb(err);\n        addMessage(conn, transac, event, options, cb);\n      });\n    }\n  ], cb); \n}\n\nfunction addEventTransac(conn, transac, options, cb){\n  try{\n    options.transacId = transac.id;\n    let event = new Event(options);\n    transac.addEvent(event);\n    r.table(Transac.collection).insert( event, {returnChanges: true} ).run(conn, (err, res) => {\n      if(err)return cb(err);\n      cb(null, event, transac);\n    });\n  }catch(e){\n    setImmediate(cb, e);\n  }\n}\n\nfunction addMessage(conn, transac, event, options, cb){\n  try{\n    let message = new Message({label: options.message, transacId: options.transacId});\n    event.addChild(message);\n    r.table(Transac.collection).insert( message, {returnChanges: true} ).run(conn, (err, res) => {\n      if(err)return cb(err);\n      cb(null, event, transac);\n    });\n  }catch(e){\n    setImmediate(cb, e);\n  }\n}\n"],"sourceRoot":"/home/redpelicans/transacd2/src/server"}