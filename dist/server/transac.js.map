{"version":3,"sources":["transac.js"],"names":[],"mappings":"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","file":"transac.js","sourcesContent":["'use strict';\nvar redMongo = require('mongobless')\n    , ObjectID = redMongo.ObjectID\n    , moment = require('moment')\n    , async = require('async')\n    , _ = require('lodash');\n\nvar Event = function(options){\n  this.time = new Date();\n  this.type = options.type;\n  this.label = options.label;\n  this.message = options.message;\n}\n\nEvent.prototype = {\n  toJSON: function(){\n    return {\n      label: this.label,\n      time: +this.time,\n      type: this.type,\n      message: this.message\n    }\n  }\n}\n\nvar ElementaryTransac = function(options){\n  this.processingTime = new Date();\n  if(options.server) this.server = options.server;\n  if(options.user) this.user = options.user;\n  if(options.processId) this.processId = options.processId;\n  this.events = [];\n  this.status = 'ok';\n}\n\nvar ElementaryTransacProto = {\n\n  toJSON: function(){\n    return {\n      processingTime: +this.processingTime,\n      status: this.status,\n      isRunning: this.isRunning(),\n      server: this.server,\n      user: this.user,\n      processId: this.processId,\n      delay: this.delay,\n      events: _.map(this.events, function(event){return event.toJSON()})\n    }\n  },\n\n  hasEventTypes: function(types){\n    return _.some(this.events, function(event){return _.contains(types, event.type)});\n  },\n\n  isRunning: function(){\n    return !this.hasEventTypes(['abort', 'commit']);\n  },\n\n  // get status(){\n  //   if(!this.lastEvent) return 'ok';\n  //   if(this.hasEventTypes(['error'])) return 'error';\n  //   if(this.hasEventTypes(['warning'])) return 'warning';\n  //   return 'ok';\n  // },\n\n  get lastEvent(){\n    return this.events[this.events.length - 1];\n  },\n\n  get lastEventTime(){\n    return this.lastEvent && this.lastEvent.time;\n  },\n\n  get delay(){\n    if(this.lastEvent) return this.lastEvent.time - this.processingTime;\n    else return 0;\n  },\n\n  computeStatus: function(event){\n    switch(event.type){\n      case 'error':\n      case 'abort':\n        this.status = 'error';\n        break;\n      case 'warning':\n        if(this.status == 'ok')this.status = 'warning';\n    }\n    return this.status;\n  }\n}\n\nElementaryTransac.prototype = ElementaryTransacProto;\n\nvar Transac = redMongo.defineModel({\n  collection: \"transacs\",\n  instanceMethods: {\n    isLocked: function(){\n      return this.locked;\n    },\n\n    isMulti: function(){\n      return this.type == 'multi';\n    },\n\n    toSummaryJSON: function(){\n      return {\n        id: this._id,\n        name: this.name,\n        valueDate: +this.valueDate,\n        processingTime: +this.processingTime,\n        lastEventTime: +this.lastEventTime,\n        locked: this.isLocked(),\n        status: this.status,\n        isRunning: this.isRunning(),\n        isMulti: this.isMulti(),\n        server: this.server,\n        delay: this.delay\n      }\n    }\n  }\n})\n\nmodule.exports = Transac;\n\nTransac.factory = function(options){\n  return options.nested ? new MultiTransac(options) : new PlainTransac(options);\n}\n\nTransac.bless = function(transac){\n  switch( transac.type ){\n    case 'plain':\n      var obj = redMongo.Model.bless.bind(PlainTransac)(transac);\n      _.each(obj.events, function(event){\n        event.__proto__ = Event.prototype;\n      });\n      return obj;\n    case 'multi':\n      var obj = redMongo.Model.bless.bind(MultiTransac)(transac);\n      _.each(obj.nestedTransacs, function(nt){ \n        nt.__proto__ = ElementaryTransacProto \n        _.each(nt.events, function(event){\n          event.__proto__ = Event.prototype;\n        });\n      });\n      return obj;\n  }\n}\n\nvar PlainTransac = redMongo.defineModel({\n\n  extends: Transac,\n\n  mixins: [ElementaryTransacProto],\n\n  instanceMethods: {\n\n    toJSON: function(){\n      return {\n        id: this._id,\n        name: this.name,\n        valueDate: +this.valueDate,\n        processingTime: +this.processingTime,\n        lastEventTime: +this.lastEventTime,\n        locked: this.isLocked(),\n        status: this.status,\n        isRunning: this.isRunning(),\n        isMulti: this.isMulti(),\n        server: this.server,\n        user: this.user,\n        processId: this.processId,\n        delay: this.delay,\n        events: _.map(this.events, function(event){return event.toJSON()})\n      }\n    },\n\n    addEvent: function(event, cb){\n      var transac = this;\n      if(!transac.isRunning()) return setImmediate(cb, {message: \"Can't add an event on a non running transac\", code: 'closed'});\n      Transac.collection.update({_id: transac._id}, {$set: {status: transac.computeStatus(event)}, $push: {events: event}}, function(err){\n        if(err)return cb(err);\n        transac.events.push(event);\n        cb(null, event, transac);\n      });\n    },\n\n  },\n\n  staticMethods: {\n    init: function(options){\n      var options = fillOptions(options);\n      this.type = 'plain';\n      this.name = options.name;\n      this.valueDate = options.valueDate;\n      this.processingTime = new Date();\n      if(options.server) this.server = options.server;\n      if(options.user) this.user = options.user;\n      if(options.processId) this.processId = options.processId;\n      this.events = [];\n      this.locked = options.locked;\n      this.status = 'ok';\n    }\n  }\n});\n\nvar MultiTransac = redMongo.defineModel({\n  extends: Transac,\n\n  instanceMethods: {\n\n    toJSON: function(){\n      return {\n        id: this._id,\n        name: this.name,\n        valueDate: +this.valueDate,\n        processingTime: +this.processingTime,\n        lastEventTime: +this.lastEventTime,\n        locked: this.isLocked(),\n        status: this.status,\n        isRunning: this.isRunning(),\n        isMulti: this.isMulti(),\n        server: this.server,\n        delay: this.delay,\n        nested: _.map(this.nestedTransacs, function(nt){return nt.toJSON()}),\n      }\n    },\n\n    addEvent: function(event, cb){\n      var transac = this;\n      if(!transac.isRunning()) return setImmediate(cb, {message: \"Can't add an event on a non running transac\", code: 'closed'});\n      var count = transac.nestedTransacs.length - 1\n        , newStatus =  transac.lastElementaryTransac.computeStatus(event)\n        , statusField = 'nestedTransacs.' + count + '.status'\n        , eventField = 'nestedTransacs.' + count + '.events'\n        , statusQuery = {}\n        , eventQuery = {};\n\n      statusQuery[statusField] = newStatus;\n      eventQuery[eventField] = event;\n\n\n      Transac.collection.update({_id: transac._id}, {$set: statusQuery, $push: eventQuery}, function(err){\n        if(err) return cb(err);\n        transac.lastElementaryTransac.events.push(event);\n        cb(null, event, transac);\n      });\n    },\n\n    addNestedTransac: function(transac){\n      this.nestedTransacs.push(transac);\n    },\n\n    get lastElementaryTransac(){\n      return this.nestedTransacs[this.nestedTransacs.length - 1];\n    },\n\n    get lastEvent(){\n      return this.lastElementaryTransac.lastEvent;\n    },\n\n    get lastEventTime(){\n      return this.lastElementaryTransac.lastEventTime;\n    },\n\n    isRunning: function(){\n      return this.lastElementaryTransac.isRunning();\n    },\n\n    get status(){\n      if(_.some(this.nestedTransacs, function(transac){return transac.status == 'error' })) return 'error';\n      if(_.some(this.nestedTransacs, function(transac){return transac.status == 'warning' })) return 'warning';\n      return 'ok';\n    },\n\n    get delay(){\n      return _.inject(this.nestedTransacs, function(sum, transac){ return sum + transac.delay }, 0);\n    },\n\n    get server(){\n      return this.lastElementaryTransac.server;\n    },\n\n    get user(){\n      return this.lastElementaryTransac.user;\n    },\n\n    get processId(){\n      return this.lastElementaryTransac.processId;\n    }\n  },\n\n  staticMethods: {\n    init: function(options){\n      this.type = 'multi';\n      this.name = options.name;\n      this.valueDate = options.valueDate;\n      this.processingTime = new Date();\n      this.nestedTransacs = [new ElementaryTransac(options)];\n      this.locked = options.locked;\n    },\n  }\n})\n\nTransac.loadOrCreateFromOptions = function(options, cb){\n  var options = fillOptions(options);\n  findTransac(options, function(err, transac){\n    if(err)return cb(err);\n    if(!transac) insertTransac(Transac.factory(options), cb);\n    else if(transac.isMulti()) addNestedTransac(options, transac, cb);\n    else if(transac.isLocked()) cb({message: 'Transaction already locked', code: 'locked'});\n    else insertTransac(Transac.factory(options), cb);\n  });\n}\n\nTransac.addEventFromOptions = function(id, options, cb){\n  async.waterfall([\n    Transac.load.bind(null, id),\n    function(transac, cb){\n      if(!transac)return setImmediate(cb, {message: \"Unknown transaction\", code: 'notransac'});\n      var event = new Event(options);\n      transac.addEvent(event, cb);\n    }\n  ], cb); \n}\n\nTransac.load = function(id, cb){\n  Transac.findOne({_id: id},  function(err, transac){\n    if(err)return cb(err);\n    cb(null, transac);\n  });\n}\n\nTransac.options = ['name', 'valueDate', 'server', 'processId', 'user', 'locked', 'nested'];\n\nfunction insertTransac(transac, cb){\n  Transac.collection.insert(transac, function(err, transacs){\n    if(err)return cb(err);\n    cb(null, transacs[0]);\n  });\n}\n\nfunction addNestedTransac(options, transac, cb){\n  var nestedTransac = new ElementaryTransac(options);\n  transac.addNestedTransac(nestedTransac)\n  Transac.collection.update({_id: transac._id}, { $push: {nestedTransacs: nestedTransac}}, function(err){\n    cb(err, transac);\n  });\n}\n\n\n\nfunction findTransac(options, cb){\n  Transac.findAll({name: options.name, valueDate: options.valueDate}, {sort: {processingTime: -1}},  function(err, transacs){\n    if(err)return cb(err);\n    cb(null, transacs[0]);\n  });\n}\n\nfunction fillOptions(options){\n  return _.extend({valueDate: moment().startOf('day').toDate()}, _.pick.bind(_, options).apply(_, Transac.options));\n}\n\n\n\n"],"sourceRoot":"/home/redpelicans/transac2/src/server"}